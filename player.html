<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>🎥 Live Player - WProject</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
  <div class="player-container">
    <h1>🎬 WProject Live</h1>
    <video id="video" controls autoplay playsinline></video>
    <div class="status-bar" id="status">Menghubungkan...</div>
    <button id="logout-btn">Logout</button>
  </div>

  <script>
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.onkeydown = e => {
      if (e.key === "F12" || (e.ctrlKey && e.shiftKey && ["I", "J", "C"].includes(e.key)) || (e.ctrlKey && e.key === "U")) {
        e.preventDefault();
      }
    };

    const token = localStorage.getItem("wproject_token");
    const video = document.getElementById("video");
    const statusEl = document.getElementById("status");
    const logoutBtn = document.getElementById("logout-btn");

    if (!token) {
      statusEl.textContent = "Token tidak ditemukan. Silakan login.";
      setTimeout(() => window.location.href = "index.html", 1500);
    } else {
      validateToken(token);
    }

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("wproject_token");
      window.location.href = "index.html";
    });

    async function validateToken(token) {
      statusEl.textContent = "🔍 Memvalidasi token...";
      try {
        const res = await fetch(`https://bot.wproject.web.id/api/check?token=${token}`);
        const data = await res.json();
        if (data.valid && data.stream_url) {
          initPlayer(data.stream_url);
        } else {
          statusEl.textContent = "❌ Token tidak valid.";
          setTimeout(() => window.location.href = "index.html", 2000);
        }
      } catch {
        statusEl.textContent = "⚠️ Gagal menghubungi server.";
      }
    }

    function showStatus(msg, color = "orange") {
      statusEl.style.color = color;
      statusEl.textContent = msg;
    }

    function initPlayer(src) {
      if (Hls.isSupported()) {
        const hls = new Hls({
          maxBufferLength: 60,
          maxBufferSize: 60 * 1000 * 1000,
          liveSyncDurationCount: 4,
          liveMaxLatencyDurationCount: 8,
          startPosition: -1
        });
        hls.loadSource(src);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {
          const levels = data.levels;
          if (levels.length > 1) {
            const select = document.createElement("select");
            select.id = "quality-select";
            levels.forEach((lvl, i) => {
              const opt = document.createElement("option");
              opt.value = i;
              opt.text = `${lvl.height}p`;
              select.appendChild(opt);
            });
            select.addEventListener("change", () => {
              hls.currentLevel = parseInt(select.value);
            });
            document.body.insertBefore(select, video.nextSibling);
          }
          video.play();
          showStatus("✅ Terhubung", "green");
        });

        hls.on(Hls.Events.ERROR, (_, data) => {
          if (data.fatal) {
            showStatus("Kesalahan koneksi. Memulihkan...", "orange");
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                hls.recoverMediaError();
                break;
              default:
                hls.destroy();
                initPlayer(src);
            }
          }
        });
      } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
        video.src = src;
        video.addEventListener("loadedmetadata", () => video.play());
      }
    }
  </script>
</body>
</html>
