<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WProject Stream | Player</title>
<link rel="stylesheet" href="style.css">
<style>
video { width: 100%; max-width: 960px; border-radius: 10px; margin-top: 20px; }
select { margin-top: 10px; padding: 8px; border-radius: 6px; }
</style>
</head>
<body oncontextmenu="return false">
<div class="container">
  <h2>ðŸ“¡ WProject Live</h2>
  <div id="playerBox" style="display:none">
    <video id="video" controls playsinline></video>
    <br>
    <label>Pilih Resolusi: </label>
    <select id="quality" onchange="changeQuality(this.value)"></select>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
// Anti devtools
document.addEventListener('keydown', e => {
  if (e.key === 'F12' ||
      (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key)) ||
      (e.ctrlKey && e.key === 'U')) e.preventDefault();
});
document.addEventListener('contextmenu', e => e.preventDefault());

const token = localStorage.getItem("wproject_token");
if (!token) {
  alert("Token tidak ditemukan!");
  window.location.href = "index.html";
}

async function validateToken() {
  try {
    const res = await fetch(`https://bot.wproject.web.id/api/check?token=${token}`);
    const data = await res.json();
    if (!data.valid) {
      alert("Token tidak valid!");
      localStorage.removeItem("wproject_token");
      window.location.href = "index.html";
      return;
    }
    initPlayer(data.stream_url);
  } catch {
    alert("Gagal validasi token.");
    window.location.href = "index.html";
  }
}

let hls;
function initPlayer(src) {
  const video = document.getElementById("video");
  const select = document.getElementById("quality");
  document.getElementById("playerBox").style.display = "block";

  if (Hls.isSupported()) {
    hls = new Hls({
      liveSyncDuration: 10,
      liveMaxLatencyDuration: 60,
      maxBufferLength: 30,
      maxMaxBufferLength: 60,
      liveDurationInfinity: true,
      enableWorker: true,
      lowLatencyMode: false,
      backBufferLength: 120,
      manifestLoadingTimeOut: 10000,
      fragLoadingTimeOut: 10000,
      manifestLoadingMaxRetry: 10,
      fragLoadingMaxRetry: 8,
      fragLoadingRetryDelay: 2000
    });
    hls.loadSource(src + `?t=${Date.now()}`);
    hls.attachMedia(video);

    hls.on(Hls.Events.MANIFEST_PARSED, (_, data) => {
      select.innerHTML = '<option value="-1">Auto</option>';
      data.levels.forEach((lvl, i) => {
        select.innerHTML += `<option value="${i}">${lvl.height}p</option>`;
      });
      video.play();
    });

    // Auto recovery buffering
    let last = 0;
    setInterval(() => {
      if (!video.paused && video.currentTime === last) {
        console.log("âš ï¸ Player stuck, restart segment load...");
        hls.startLoad();
      }
      last = video.currentTime;
    }, 10000);

    hls.on(Hls.Events.ERROR, (_, data) => {
      if (data.fatal) {
        switch (data.type) {
          case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
          case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
          default:
            hls.destroy();
            initPlayer(src);
        }
      }
    });

  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = src;
    video.play();
  }
}

function changeQuality(v) {
  if (!hls) return;
  hls.currentLevel = parseInt(v);
}

validateToken();
</script>
</body>
</html>
